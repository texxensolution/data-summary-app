<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Summary Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8fafc;
            color: #334155;
            line-height: 1.6;
            padding: 1rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem 0;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1rem;
            color: #64748b;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .upload-area {
            text-align: center;
        }

        .upload-dropzone {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 2rem;
            cursor: pointer;
            transition: all 0.2s;
            background-color: #fafafa;
        }

        .upload-dropzone:hover {
            border-color: #3b82f6;
            background-color: #f0f9ff;
        }

        .upload-dropzone.dragover {
            border-color: #3b82f6;
            background-color: #dbeafe;
        }

        .file-input {
            display: none;
        }

        .upload-icon {
            width: 3rem;
            height: 3rem;
            margin: 0 auto 1rem;
            color: #64748b;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .summary-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            border-left: 4px solid #3b82f6;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-top: 1px solid #e2e8f0;
            border-right: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .summary-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1e293b;
        }

        .summary-total {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #3b82f6;
        }

        .summary-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            font-size: 0.875rem;
            color: #64748b;
            flex: 1;
            margin-right: 1rem;
        }

        .summary-value {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .summary-count {
            font-weight: 600;
            background-color: #f1f5f9;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            color: #475569;
        }

        .summary-percent {
            font-size: 0.75rem;
            color: #94a3b8;
            min-width: 2rem;
            text-align: right;
        }

        .controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin: 1.5rem 0;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            font-size: 0.875rem;
            text-decoration: none;
            transition: all 0.2s;
            background-color: #3b82f6;
            color: white;
        }

        .btn:hover {
            background-color: #2563eb;
        }

        .btn-green {
            background-color: #10b981;
        }

        .btn-green:hover {
            background-color: #059669;
        }

        .btn-purple {
            background-color: #8b5cf6;
        }

        .btn-purple:hover {
            background-color: #7c3aed;
        }

        .btn-orange {
            background-color: #f59e0b;
        }

        .btn-orange:hover {
            background-color: #d97706;
        }

        .total-counter {
            text-align: center;
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border: 1px solid #e2e8f0;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            color: #3b82f6;
            margin: 1.5rem 0;
            font-weight: 500;
        }

        .spinner {
            width: 1.5rem;
            height: 1.5rem;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .table-container {
            overflow-x: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-top: 1rem;
            background: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        th {
            background-color: #f8fafc;
            color: #475569;
            padding: 0.75rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #e2e8f0;
        }

        td {
            padding: 0.75rem;
            text-align: center;
            border-bottom: 1px solid #f1f5f9;
            background: white;
        }

        tr:nth-child(even) td {
            background: #fafafa;
        }

        tr:hover td {
            background: #f0f9ff;
        }

        .table-header-main {
            background-color: #3b82f6 !important;
            color: white !important;
            font-weight: 600;
        }

        .table-subheader {
            background-color: #64748b !important;
            color: white !important;
            font-weight: 500;
        }

        .area-cell {
            background: #f0fdf4 !important;
            font-weight: 600;
            text-align: left !important;
            padding-left: 1rem !important;
            color: #166534;
        }

        .total-row td {
            background: #dbeafe !important;
            font-weight: 600;
            color: #1e40af;
        }

        .mapping-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .mapping-group {
            background: #fafafa;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
        }

        .mapping-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .mapping-select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
            background: white;
        }

        .mapping-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .file-header {
            background-color: #3b82f6;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .hidden {
            display: none !important;
        }

        .icon {
            width: 1rem;
            height: 1rem;
            fill: currentColor;
        }

        @media (max-width: 768px) {
            body {
                padding: 0.5rem;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 250px;
                justify-content: center;
            }
            
            .mapping-grid {
                grid-template-columns: 1fr;
            }
            
            .card {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“Š Data Summary Analytics</h1>
            <p>Upload CSV files and generate professional summaries with advanced export options</p>
        </div>

        <div id="upload-section" class="card">
            <div class="upload-area">
                <div class="upload-dropzone" id="dropzone">
                    <input type="file" id="file-input" class="file-input" multiple accept=".csv">
                    <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7,10 12,15 17,10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    <h3 style="font-size: 1.5rem; margin-bottom: 0.5rem; font-weight: 700;">Drop CSV files here</h3>
                    <p style="color: #64748b; font-weight: 500;">or click to browse and select files</p>
                </div>
            </div>
        </div>

        <div id="mapping-section" class="card hidden">
            <div class="summary-header">
                <h3 class="summary-title">ðŸ”§ Column Mapping Configuration</h3>
                <div>
                    <button id="use-auto-mapping" class="btn btn-orange" style="margin-right: 1rem;">Auto-Map</button>
                    <button id="apply-mapping" class="btn btn-green">Apply & Continue</button>
                </div>
            </div>
            <div id="mapping-container"></div>
        </div>

        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <span>Processing your files...</span>
        </div>

        <div id="summary-section" class="hidden">
            <div class="total-counter">
                <span id="total-records">ðŸ“ˆ Total Records: 0</span>
            </div>

            <!-- Cancel Filter Control -->
            <div class="card">
                <div class="summary-header">
                    <h3 class="summary-title">ðŸ”§ Filter Options</h3>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="exclude-cancel" checked style="transform: scale(1.2);">
                        <span style="font-weight: 500;">Exclude CANCEL/Cancel status</span>
                    </label>
                </div>
            </div>

            <div class="controls">
                <button id="export-all-csv" class="btn btn-green">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7,10 12,15 17,10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Export All Data
                </button>
                <button id="export-summary" class="btn btn-purple">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <polyline points="21,15 16,10 5,21"/>
                    </svg>
                    Export Summary
                </button>
            </div>

            <div id="summary-export-area">
                <!-- Worklist Table -->
                <div class="card" id="worklist-summary">
                    <div class="summary-header">
                        <h3 class="summary-title">ðŸ“‹ Worklist Summary</h3>
                        <button class="btn btn-green" onclick="exportWorklistSummary()">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7,10 12,15 17,10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            Export Worklist
                        </button>
                    </div>
                    <div class="table-container" id="worklist-table"></div>
                </div>

                <!-- Result Table -->
                <div class="card" id="result-summary">
                    <div class="summary-header">
                        <h3 class="summary-title">ðŸ“Š Result Summary</h3>
                        <button class="btn btn-green" onclick="exportResultSummary()">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7,10 12,15 17,10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            Export Result
                        </button>
                    </div>
                    <div class="table-container" id="result-table"></div>
                </div>
                
                <div class="summary-grid" id="summary-cards"></div>
            </div>
        </div>
    </div>

    <script>
        let parsedData = [];
        let consolidatedData = [];
        let summaryStats = null;
        let manualColumnMappings = {};

        const standardColumns = {
            bank: ['BANK NAME', 'BANK', 'bank_txt', 'BANK NAME REAL'],
            area: ['AREA', 'FINAL AREA', 'final_area_txt', 'AREA CLUSTER'],
            cluster: ['CLUSTER', 'CH CODE', 'CH NAME'],
            status: ['account_status', 'STATUS', 'reported_status', 'OPEN CI STATUS', 'RESULT', 'VISIT STATUS'],
            fieldRider: ['ASSIGNED FS', 'FIELDMAN', 'Creator', 'FIELD RIDER', 'FS NAME'],
            chCode: ['CH CODE', 'REF CODE', 'REFERENCE'],
            date: ['Creation Date', 'Result_Date', 'result_date', 'VISITED DATE', 'Modified Date', 'DATE']
        };

        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
        });

        function initializeEventListeners() {
            const fileInput = document.getElementById('file-input');
            const dropzone = document.getElementById('dropzone');

            dropzone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileUpload);

            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('dragover');
            });

            dropzone.addEventListener('dragleave', () => {
                dropzone.classList.remove('dragover');
            });

            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('dragover');
                const droppedFiles = Array.from(e.dataTransfer.files);
                processFiles(droppedFiles);
            });

            document.getElementById('export-all-csv').addEventListener('click', exportAllData);
            document.getElementById('export-summary').addEventListener('click', exportSummaryImage);
            document.getElementById('use-auto-mapping').addEventListener('click', useAutoMapping);
            document.getElementById('apply-mapping').addEventListener('click', applyManualMapping);
            
            // Cancel filter event listener
            document.getElementById('exclude-cancel').addEventListener('change', function() {
                if (consolidatedData.length > 0) {
                    generateSummary();
                    showSummary();
                }
            });
        }

        async function handleFileUpload(event) {
            const uploadedFiles = Array.from(event.target.files);
            await processFiles(uploadedFiles);
        }

        async function processFiles(files) {
            if (files.length === 0) return;

            const loadingElement = document.getElementById('loading');
            loadingElement.classList.remove('hidden');
            
            try {
                parsedData = [];
                consolidatedData = [];
                summaryStats = null;
                manualColumnMappings = {};
                
                for (const file of files) {
                    try {
                        const text = await file.text();
                        const parsed = Papa.parse(text, {
                            header: true,
                            dynamicTyping: true,
                            skipEmptyLines: true,
                            delimitersToGuess: [',', '\t', '|', ';']
                        });
                        
                        if (parsed.errors && parsed.errors.length > 0) {
                            console.warn(`Parsing warnings for ${file.name}:`, parsed.errors);
                        }
                        
                        const cleanedData = parsed.data
                            .filter(row => {
                                return Object.values(row).some(value => 
                                    value !== null && 
                                    value !== undefined && 
                                    value !== '' && 
                                    String(value).trim() !== ''
                                );
                            })
                            .map(row => {
                                const cleanRow = {};
                                Object.keys(row).forEach(key => {
                                    const cleanKey = key.trim();
                                    cleanRow[cleanKey] = row[key];
                                });
                                return cleanRow;
                            });
                        
                        if (cleanedData.length > 0) {
                            parsedData.push({
                                name: file.name,
                                data: cleanedData,
                                headers: Object.keys(cleanedData[0] || {}),
                                rowCount: cleanedData.length
                            });
                        }
                        
                    } catch (fileError) {
                        console.error(`Error processing file ${file.name}:`, fileError);
                        alert(`Error processing file ${file.name}. Please check if it's a valid CSV file.`);
                    }
                }
                
                if (parsedData.length === 0) {
                    alert('No valid data found in the uploaded files.');
                    return;
                }
                
                showColumnMapping();
                console.log('File processing completed successfully!');
                
            } catch (error) {
                console.error('Error processing files:', error);
                alert('Error processing files. Please try again with valid CSV files.');
            } finally {
                loadingElement.classList.add('hidden');
                const fileInput = document.getElementById('file-input');
                fileInput.value = '';
            }
        }

        function showColumnMapping() {
            const mappingSection = document.getElementById('mapping-section');
            const mappingContainer = document.getElementById('mapping-container');
            
            mappingContainer.innerHTML = '';
            manualColumnMappings = {};
            
            parsedData.forEach((file, fileIndex) => {
                const autoMapping = {};
                Object.keys(standardColumns).forEach(stdCol => {
                    const matchedCol = file.headers.find(header => 
                        standardColumns[stdCol].some(variant => 
                            header.toUpperCase().includes(variant.toUpperCase())
                        )
                    );
                    if (matchedCol) {
                        autoMapping[stdCol] = matchedCol;
                    }
                });
                
                manualColumnMappings[fileIndex] = autoMapping;
                
                const fileMapping = document.createElement('div');
                fileMapping.className = 'mapping-group';
                
                fileMapping.innerHTML = `
                    <div class="file-header">
                        ðŸ“„ ${file.name} (${file.rowCount} rows)
                    </div>
                    <div class="mapping-grid">
                        ${Object.keys(standardColumns).map(columnType => `
                            <div>
                                <label class="mapping-label">
                                    ${columnType.replace(/([A-Z])/g, ' $1').trim()}
                                </label>
                                <select class="mapping-select" data-file-index="${fileIndex}" data-column-type="${columnType}">
                                    <option value="">-- Select Column --</option>
                                    ${file.headers.map(header => `
                                        <option value="${header}" ${autoMapping[columnType] === header ? 'selected' : ''}>
                                            ${header}
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                mappingContainer.appendChild(fileMapping);
            });
            
            document.querySelectorAll('.mapping-select').forEach(select => {
                select.addEventListener('change', (e) => {
                    const fileIndex = parseInt(e.target.getAttribute('data-file-index'));
                    const columnType = e.target.getAttribute('data-column-type');
                    const selectedColumn = e.target.value;
                    
                    if (!manualColumnMappings[fileIndex]) {
                        manualColumnMappings[fileIndex] = {};
                    }
                    manualColumnMappings[fileIndex][columnType] = selectedColumn;
                });
            });
            
            mappingSection.classList.remove('hidden');
        }

        function useAutoMapping() {
            manualColumnMappings = {};
            parsedData.forEach((file, fileIndex) => {
                const autoMapping = {};
                Object.keys(standardColumns).forEach(stdCol => {
                    const matchedCol = file.headers.find(header => 
                        standardColumns[stdCol].some(variant => 
                            header.toUpperCase().includes(variant.toUpperCase())
                        )
                    );
                    if (matchedCol) {
                        autoMapping[stdCol] = matchedCol;
                    }
                });
                manualColumnMappings[fileIndex] = autoMapping;
            });
            
            document.querySelectorAll('.mapping-select').forEach(select => {
                const fileIndex = parseInt(select.getAttribute('data-file-index'));
                const columnType = select.getAttribute('data-column-type');
                const autoValue = manualColumnMappings[fileIndex]?.[columnType] || '';
                select.value = autoValue;
            });
            
            alert('Auto-mapping applied! Review the selections and click "Apply & Continue" to proceed.');
        }

        function applyManualMapping() {
            const hasMappings = Object.values(manualColumnMappings).some(mapping => 
                Object.values(mapping).some(value => value !== '')
            );
            
            if (!hasMappings) {
                alert('Please map at least some columns before proceeding.');
                return;
            }
            
            consolidateData();
            generateSummary();
            showSummary();
            
            document.getElementById('mapping-section').classList.add('hidden');
        }

        function consolidateData() {
            try {
                consolidatedData = [];
                
                if (!parsedData || parsedData.length === 0) {
                    console.log('No parsed data available for consolidation');
                    return;
                }
                
                parsedData.forEach((file, fileIndex) => {
                    console.log(`Processing file: ${file.name} with ${file.data.length} rows`);
                    
                    const columnMap = manualColumnMappings[fileIndex] || {};
                    
                    if (Object.keys(columnMap).length === 0) {
                        Object.keys(standardColumns).forEach(stdCol => {
                            const matchedCol = file.headers.find(header => 
                                standardColumns[stdCol].some(variant => 
                                    header.toUpperCase().includes(variant.toUpperCase())
                                )
                            );
                            if (matchedCol) {
                                columnMap[stdCol] = matchedCol;
                            }
                        });
                    }
                    
                    console.log(`Column mapping for ${file.name}:`, columnMap);
                    
                    file.data.forEach((row, rowIndex) => {
                        const hasData = Object.values(row).some(value => 
                            value !== null && 
                            value !== undefined && 
                            value !== '' && 
                            String(value).trim() !== ''
                        );
                        
                        if (hasData) {
                            const consolidatedRow = {
                                fileName: file.name,
                                bank: row[columnMap.bank] || 'Unknown',
                                area: row[columnMap.area] || 'Unknown',
                                cluster: row[columnMap.cluster] || 'Unknown',
                                status: row[columnMap.status] || 'Unknown',
                                fieldRider: row[columnMap.fieldRider] || 'Unknown',
                                chCode: row[columnMap.chCode] || 'Unknown',
                                date: row[columnMap.date] || 'Unknown',
                                originalRow: row
                            };
                            consolidatedData.push(consolidatedRow);
                        }
                    });
                });
                
                console.log(`Consolidated ${consolidatedData.length} total records from ${parsedData.length} files`);
                
            } catch (error) {
                console.error('Error in consolidateData:', error);
                alert('Error consolidating data. Please check your CSV file format.');
            }
        }

        function generateSummary() {
            try {
                if (!consolidatedData || consolidatedData.length === 0) {
                    console.log('No consolidated data available for summary generation');
                    summaryStats = null;
                    return;
                }

                // Check if cancel should be excluded
                const excludeCancel = document.getElementById('exclude-cancel')?.checked || false;
                
                // Filter data based on cancel exclusion
                const filteredData = excludeCancel 
                    ? consolidatedData.filter(row => 
                        !row.status.toLowerCase().includes('cancel')
                    )
                    : consolidatedData;

                const stats = {
                    total: filteredData.length,
                    totalAll: consolidatedData.length,
                    byBank: {},
                    byArea: {},
                    byStatus: {},
                    byFieldRider: {},
                    byCluster: {}
                };

                filteredData.forEach(row => {
                    stats.byBank[row.bank] = (stats.byBank[row.bank] || 0) + 1;
                    stats.byArea[row.area] = (stats.byArea[row.area] || 0) + 1;
                    stats.byStatus[row.status] = (stats.byStatus[row.status] || 0) + 1;
                    stats.byFieldRider[row.fieldRider] = (stats.byFieldRider[row.fieldRider] || 0) + 1;
                    stats.byCluster[row.cluster] = (stats.byCluster[row.cluster] || 0) + 1;
                });

                summaryStats = {
                    total: stats.total,
                    totalAll: stats.totalAll,
                    filteredData: filteredData,
                    byBank: Object.entries(stats.byBank).sort((a, b) => b[1] - a[1]),
                    byArea: Object.entries(stats.byArea).sort((a, b) => b[1] - a[1]),
                    byStatus: Object.entries(stats.byStatus).sort((a, b) => b[1] - a[1]),
                    byFieldRider: Object.entries(stats.byFieldRider).sort((a, b) => b[1] - a[1]),
                    byCluster: Object.entries(stats.byCluster).sort((a, b) => b[1] - a[1])
                };
                
                console.log('Summary stats generated:', summaryStats);
                
            } catch (error) {
                console.error('Error in generateSummary:', error);
                summaryStats = null;
                alert('Error generating summary statistics.');
            }
        }

        function showSummary() {
            if (!summaryStats) return;

            const excludeCancel = document.getElementById('exclude-cancel')?.checked || false;
            const displayText = excludeCancel 
                ? `ðŸ“ˆ Total Records: ${summaryStats.total.toLocaleString()} (${summaryStats.totalAll.toLocaleString()} total, ${summaryStats.totalAll - summaryStats.total} cancelled excluded)`
                : `ðŸ“ˆ Total Records: ${summaryStats.total.toLocaleString()}`;
            
            document.getElementById('total-records').textContent = displayText;

            createWorklistTable();
            createResultTable();

            const summaryCards = document.getElementById('summary-cards');
            summaryCards.innerHTML = '';

            const cardConfigs = [
                { title: 'ðŸ¦ By Bank', data: summaryStats.byBank, color: '#10b981' },
                { title: 'ðŸ“ By Area', data: summaryStats.byArea, color: '#3b82f6' },
                { title: 'ðŸ“Š By Status', data: summaryStats.byStatus, color: '#ef4444' },
                { title: 'ðŸ‘¤ By Field Rider', data: summaryStats.byFieldRider, color: '#f59e0b' },
                { title: 'ðŸ¢ By Cluster', data: summaryStats.byCluster, color: '#8b5cf6' }
            ];

            cardConfigs.forEach(config => {
                const card = createSummaryCard(config);
                summaryCards.appendChild(card);
            });

            document.getElementById('summary-section').classList.remove('hidden');
        }

        function createWorklistTable() {
            if (!summaryStats || !summaryStats.filteredData.length) return;

            const dataToUse = summaryStats.filteredData;
            const areaData = {};

            // Group data by area for worklist (count all records, unique skiptracers)
            dataToUse.forEach(row => {
                const area = row.area;
                if (!areaData[area]) {
                    areaData[area] = {
                        bpiSkip: 0,
                        bdoSkip: 0,
                        shared: 0,
                        total: 0,
                        uniqueSkiptracers: new Set()
                    };
                }
                
                // Count by bank type for skip columns
                if (row.bank.toLowerCase().includes('bpi')) {
                    areaData[area].bpiSkip += 1;
                } else if (row.bank.toLowerCase().includes('bdo')) {
                    areaData[area].bdoSkip += 1;
                } else {
                    areaData[area].shared += 1;
                }
                
                areaData[area].total += 1;
                areaData[area].uniqueSkiptracers.add(row.fieldRider);
            });

            const tableContainer = document.getElementById('worklist-table');
            const currentDate = new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th colspan="5" class="table-header-main">
                                ${currentDate.toUpperCase()} 8AM
                            </th>
                        </tr>
                        <tr>
                            <th colspan="5" class="table-subheader" style="background-color: #64748b !important;">
                                WORKLIST
                            </th>
                        </tr>
                        <tr>
                            <th class="table-subheader">AREA CLUSTER</th>
                            <th class="table-subheader">BPI SKIP</th>
                            <th class="table-subheader">BDO SKIP</th>
                            <th class="table-subheader">SHARED</th>
                            <th class="table-subheader">TOTAL</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Calculate totals
            let totalBpiSkip = 0;
            let totalBdoSkip = 0;
            let totalShared = 0;
            let totalRecords = 0;

            Object.entries(areaData).forEach(([area, data]) => {
                tableHTML += `
                    <tr>
                        <td class="area-cell">${area}</td>
                        <td>${data.bpiSkip}</td>
                        <td>${data.bdoSkip}</td>
                        <td>${data.shared}</td>
                        <td>${data.total}</td>
                    </tr>
                `;
                
                totalBpiSkip += data.bpiSkip;
                totalBdoSkip += data.bdoSkip;
                totalShared += data.shared;
                totalRecords += data.total;
            });

            tableHTML += `
                    <tr class="total-row">
                        <td><strong>TOTAL</strong></td>
                        <td><strong>${totalBpiSkip}</strong></td>
                        <td><strong>${totalBdoSkip}</strong></td>
                        <td><strong>${totalShared}</strong></td>
                        <td><strong>${totalRecords}</strong></td>
                    </tr>
                </tbody>
            </table>
            `;

            tableContainer.innerHTML = tableHTML;
        }

        function createResultTable() {
            if (!summaryStats || !summaryStats.filteredData.length) return;

            const dataToUse = summaryStats.filteredData;
            const areaData = {};

            // Group data by area for results (unique skiptracers per area)
            dataToUse.forEach(row => {
                const area = row.area;
                if (!areaData[area]) {
                    areaData[area] = {
                        visits: 0,
                        uniqueSkiptracers: new Set()
                    };
                }
                
                areaData[area].visits += 1;
                areaData[area].uniqueSkiptracers.add(row.fieldRider);
            });

            const tableContainer = document.getElementById('result-table');
            const currentDate = new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th colspan="7" class="table-header-main">
                                ${currentDate.toUpperCase()} RESULT AS OF ${new Date().toLocaleTimeString('en-US', { hour12: true })} (Less Cancel)
                            </th>
                        </tr>
                        <tr>
                            <th rowspan="2" class="table-subheader">AREA CLUSTER</th>
                            <th colspan="2" class="table-subheader">VISITED</th>
                            <th colspan="4" class="table-subheader" style="background-color: #10b981 !important; color: white;">@1K/FS</th>
                        </tr>
                        <tr>
                            <th class="table-subheader">CI</th>
                            <th class="table-subheader">SHARED</th>
                            <th class="table-subheader" style="background-color: #10b981 !important; color: white;">TOTAL</th>
                            <th class="table-subheader" style="background-color: #10b981 !important; color: white;">SKIPTRACERS</th>
                            <th class="table-subheader" style="background-color: #10b981 !important; color: white;">PROB. COST</th>
                            <th class="table-subheader" style="background-color: #10b981 !important; color: white;">COS/VISIT</th>
                            <th class="table-subheader" style="background-color: #10b981 !important; color: white;">AVE. VISIT</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            Object.entries(areaData).forEach(([area, data]) => {
                const uniqueSkipTracers = data.uniqueSkiptracers.size; // Unique count of field riders
                const dailySalaryCost = uniqueSkipTracers * 1000; // 1000 PHP per unique skiptracer
                const costPerVisit = data.visits > 0 ? (dailySalaryCost / data.visits) : 0;
                const avgVisit = uniqueSkipTracers > 0 ? (data.visits / uniqueSkipTracers) : 0;

                const ciVisits = Math.floor(data.visits * 0.6);
                const sharedVisits = data.visits - ciVisits;

                tableHTML += `
                    <tr>
                        <td class="area-cell">${area}</td>
                        <td>${ciVisits}</td>
                        <td>${sharedVisits}</td>
                        <td style="background-color: #dcfce7; color: #065f46; font-weight: 600;">${data.visits}</td>
                        <td style="background-color: #dcfce7; color: #065f46; font-weight: 600;">${uniqueSkipTracers}</td>
                        <td style="background-color: #dcfce7; color: #065f46; font-weight: 600;">${dailySalaryCost.toLocaleString()}</td>
                        <td style="background-color: #dcfce7; color: #065f46; font-weight: 600;">${costPerVisit.toFixed(2)}</td>
                        <td style="background-color: #dcfce7; color: #065f46; font-weight: 600;">${avgVisit.toFixed(2)}</td>
                    </tr>
                `;
            });

            // Calculate totals for results
            const allUniqueSkiptracers = new Set();
            let totalVisits = 0;
            
            dataToUse.forEach(row => {
                allUniqueSkiptracers.add(row.fieldRider);
                totalVisits += 1;
            });

            const totalUniqueSkiptracers = allUniqueSkiptracers.size;
            const totalDailySalaryCost = totalUniqueSkiptracers * 1000;
            const totalCostPerVisit = totalVisits > 0 ? (totalDailySalaryCost / totalVisits) : 0;
            const totalAvgVisit = totalUniqueSkiptracers > 0 ? (totalVisits / totalUniqueSkiptracers) : 0;
            
            const totalCiVisits = Math.floor(totalVisits * 0.6);
            const totalSharedVisits = totalVisits - totalCiVisits;

            tableHTML += `
                    <tr class="total-row">
                        <td><strong>TOTAL</strong></td>
                        <td><strong>${totalCiVisits}</strong></td>
                        <td><strong>${totalSharedVisits}</strong></td>
                        <td style="background-color: #dbeafe;"><strong>${totalVisits}</strong></td>
                        <td style="background-color: #dbeafe;"><strong>${totalUniqueSkiptracers}</strong></td>
                        <td style="background-color: #dbeafe;"><strong>${totalDailySalaryCost.toLocaleString()}</strong></td>
                        <td style="background-color: #dbeafe;"><strong>${totalCostPerVisit.toFixed(2)}</strong></td>
                        <td style="background-color: #dbeafe;"><strong>${totalAvgVisit.toFixed(2)}</strong></td>
                    </tr>
                </tbody>
            </table>
            `;

            tableContainer.innerHTML = tableHTML;
        }

        function createSummaryCard({ title, data, color }) {
            const total = data.reduce((sum, [, value]) => sum + value, 0);
            
            const card = document.createElement('div');
            card.className = 'summary-card';
            card.style.borderLeftColor = color;
            
            const listItems = data.slice(0, 8).map(([key, value]) => `
                <div class="summary-item">
                    <span class="summary-label">${key}</span>
                    <div class="summary-value">
                        <span class="summary-count">${value.toLocaleString()}</span>
                        <span class="summary-percent">${((value / total) * 100).toFixed(1)}%</span>
                    </div>
                </div>
            `).join('');

            card.innerHTML = `
                <div class="summary-header">
                    <h3 class="summary-title">${title}</h3>
                    <button class="btn" onclick="exportCardData('${title}', ${JSON.stringify(data).replace(/"/g, '&quot;')})">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7,10 12,15 17,10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                    </button>
                </div>
                
                <div class="summary-total" style="color: ${color};">
                    ${total.toLocaleString()}
                </div>
                
                <div class="summary-list">
                    ${listItems}
                    ${data.length > 8 ? `
                        <div style="text-align: center; padding: 0.75rem; color: #64748b; font-size: 0.875rem; font-weight: 500;">
                            ... and ${data.length - 8} more items
                        </div>
                    ` : ''}
                </div>
            `;
            
            return card;
        }

        function exportCardData(title, data) {
            const csvData = data.map(([key, value]) => ({
                [title.replace(/[^\w\s]/gi, '')]: key,
                Count: value,
                Percentage: ((value / data.reduce((sum, [, val]) => sum + val, 0)) * 100).toFixed(2) + '%'
            }));
            
            exportToCSV(csvData, `${title.replace(/[^\w\s]/gi, '').replace(/\s+/g, '_')}_Summary.csv`);
        }

        function exportWorklistSummary() {
            if (!summaryStats || !summaryStats.filteredData.length) {
                alert('No data to export');
                return;
            }

            const dataToUse = summaryStats.filteredData;
            const areaData = {};

            dataToUse.forEach(row => {
                const area = row.area;
                if (!areaData[area]) {
                    areaData[area] = {
                        bpiSkip: 0,
                        bdoSkip: 0,
                        shared: 0,
                        total: 0
                    };
                }
                
                if (row.bank.toLowerCase().includes('bpi')) {
                    areaData[area].bpiSkip += 1;
                } else if (row.bank.toLowerCase().includes('bdo')) {
                    areaData[area].bdoSkip += 1;
                } else {
                    areaData[area].shared += 1;
                }
                
                areaData[area].total += 1;
            });

            const csvData = Object.entries(areaData).map(([area, data]) => ({
                'Area Cluster': area,
                'BPI Skip': data.bpiSkip,
                'BDO Skip': data.bdoSkip,
                'Shared': data.shared,
                'Total': data.total
            }));

            exportToCSV(csvData, 'Worklist_Summary.csv');
        }

        function exportResultSummary() {
            if (!summaryStats || !summaryStats.filteredData.length) {
                alert('No data to export');
                return;
            }

            const dataToUse = summaryStats.filteredData;
            const areaData = {};

            dataToUse.forEach(row => {
                const area = row.area;
                if (!areaData[area]) {
                    areaData[area] = {
                        visits: 0,
                        uniqueSkiptracers: new Set()
                    };
                }
                
                areaData[area].visits += 1;
                areaData[area].uniqueSkiptracers.add(row.fieldRider);
            });

            const csvData = Object.entries(areaData).map(([area, data]) => {
                const uniqueSkipTracers = data.uniqueSkiptracers.size;
                const dailySalaryCost = uniqueSkipTracers * 1000;
                const costPerVisit = data.visits > 0 ? (dailySalaryCost / data.visits) : 0;
                const avgVisit = uniqueSkipTracers > 0 ? (data.visits / uniqueSkipTracers) : 0;
                const ciVisits = Math.floor(data.visits * 0.6);
                const sharedVisits = data.visits - ciVisits;

                return {
                    'Area Cluster': area,
                    'CI Visits': ciVisits,
                    'Shared Visits': sharedVisits,
                    'Total Visits': data.visits,
                    'Unique Skiptracers': uniqueSkipTracers,
                    'Daily Salary Cost (1K/FS)': dailySalaryCost,
                    'Cost Per Visit': costPerVisit.toFixed(2),
                    'Average Visit per Skiptracer': avgVisit.toFixed(2)
                };
            });

            exportToCSV(csvData, 'Result_Summary.csv');
        }

        function exportAllData() {
            if (!consolidatedData.length) {
                alert('No data to export');
                return;
            }

            const excludeCancel = document.getElementById('exclude-cancel')?.checked || false;
            const dataToExport = excludeCancel 
                ? consolidatedData.filter(row => !row.status.toLowerCase().includes('cancel'))
                : consolidatedData;

            const exportData = dataToExport.map(row => ({
                'File Name': row.fileName,
                'Bank': row.bank,
                'Area': row.area,
                'Cluster': row.cluster,
                'Status': row.status,
                'Field Rider': row.fieldRider,
                'CH Code': row.chCode,
                'Date': row.date
            }));
            
            const filename = excludeCancel ? 'Complete_Data_Export_Less_Cancel.csv' : 'Complete_Data_Export.csv';
            exportToCSV(exportData, filename);
        }

        function exportToCSV(data, filename) {
            try {
                const csv = Papa.unparse(data);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.href = url;
                link.download = filename;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }, 100);
                
            } catch (error) {
                console.error('Error exporting CSV:', error);
                alert('Error exporting CSV file. Please try again.');
            }
        }

        function exportSummaryImage() {
            const summaryArea = document.getElementById('summary-export-area');
            if (!summaryArea) {
                alert('No summary to export');
                return;
            }

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = 1400;
            canvas.height = 900;
            
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, '#0ea5e9');
            gradient.addColorStop(0.5, '#3b82f6');
            gradient.addColorStop(1, '#8b5cf6');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 40px Inter';
            ctx.textAlign = 'center';
            ctx.fillText('ðŸ“Š Data Summary Analytics Report', canvas.width / 2, 60);
            
            ctx.font = '18px Inter';
            ctx.fillStyle = '#f1f5f9';
            ctx.fillText(`Generated: ${new Date().toLocaleString()}`, canvas.width / 2, 90);
            
            ctx.font = 'bold 28px Inter';
            ctx.fillStyle = '#ffffff';
            ctx.fillText(`Total Records: ${summaryStats?.total.toLocaleString() || 0}`, canvas.width / 2, 140);
            
            if (summaryStats) {
                let yPos = 190;
                ctx.font = '20px Inter';
                ctx.textAlign = 'left';
                ctx.fillStyle = '#ffffff';
                
                const summaries = [
                    `ðŸ¦ Banks: ${summaryStats.byBank.length} different banks`,
                    `ðŸ“ Areas: ${summaryStats.byArea.length} different areas`,
                    `ðŸ“Š Status Types: ${summaryStats.byStatus.length} different statuses`,
                    `ðŸ‘¤ Field Riders: ${summaryStats.byFieldRider.length} different field riders`,
                    `ðŸ¢ Clusters: ${summaryStats.byCluster.length} different clusters`
                ];
                
                summaries.forEach(text => {
                    ctx.fillText(text, 80, yPos);
                    yPos += 35;
                });
                
                yPos += 30;
                ctx.font = 'bold 24px Inter';
                ctx.fillText('ðŸ”¥ Top Items by Category:', 80, yPos);
                yPos += 40;
                
                ctx.font = '18px Inter';
                const categories = [
                    { name: 'ðŸ¦ Top Banks', data: summaryStats.byBank.slice(0, 3) },
                    { name: 'ðŸ“ Top Areas', data: summaryStats.byArea.slice(0, 3) },
                    { name: 'ðŸ“Š Top Statuses', data: summaryStats.byStatus.slice(0, 3) }
                ];
                
                categories.forEach(category => {
                    ctx.font = 'bold 20px Inter';
                    ctx.fillText(`${category.name}:`, 80, yPos);
                    yPos += 30;
                    
                    ctx.font = '16px Inter';
                    category.data.forEach(([name, count]) => {
                        ctx.fillText(`  â€¢ ${name}: ${count.toLocaleString()}`, 100, yPos);
                        yPos += 25;
                    });
                    yPos += 15;
                });
            }
            
            canvas.toBlob((blob) => {
                if (blob) {
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.href = url;
                    link.download = 'Data_Summary_Analytics_Report.png';
                    link.style.display = 'none';
                    
                    document.body.appendChild(link);
                    link.click();
                    
                    setTimeout(() => {
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                    }, 100);
                }
            }, 'image/png');
        }
    </script>
</body>
</html>