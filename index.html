<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Summary Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 50%, #8b5cf6 100%);
            min-height: 100vh;
            padding: 2rem;
            color: #1e293b;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            background: linear-gradient(45deg, #f8fafc, #e2e8f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.125rem;
            opacity: 0.95;
            font-weight: 500;
        }

        .card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 1.5rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .upload-area {
            text-align: center;
        }

        .upload-dropzone {
            border: 3px dashed #0ea5e9;
            border-radius: 1.5rem;
            padding: 3rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.05), rgba(59, 130, 246, 0.05));
        }

        .upload-dropzone:hover {
            border-color: #3b82f6;
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.1), rgba(59, 130, 246, 0.1));
            transform: translateY(-4px);
        }

        .upload-dropzone.dragover {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
            transform: scale(1.02);
        }

        .file-input {
            display: none;
        }

        .upload-icon {
            width: 4rem;
            height: 4rem;
            margin: 0 auto 1rem;
            color: #0ea5e9;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .summary-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(248,250,252,0.9));
            border-radius: 1rem;
            padding: 1.5rem;
            border-left: 4px solid;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .summary-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.15);
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .summary-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: #1e293b;
        }

        .summary-total {
            font-size: 2.25rem;
            font-weight: 800;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #0ea5e9, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .summary-list {
            max-height: 280px;
            overflow-y: auto;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(14, 165, 233, 0.1);
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            font-size: 0.875rem;
            color: #475569;
            flex: 1;
            margin-right: 1rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-weight: 500;
        }

        .summary-value {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .summary-count {
            font-weight: 700;
            background: linear-gradient(135deg, #0ea5e9, #3b82f6);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
        }

        .summary-percent {
            font-size: 0.75rem;
            color: #64748b;
            min-width: 3rem;
            text-align: right;
            font-weight: 600;
        }

        .controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin: 2rem 0;
        }

        .btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 1.75rem;
            border-radius: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 0.875rem;
            text-decoration: none;
            color: white;
            background: linear-gradient(135deg, #0ea5e9, #3b82f6);
            box-shadow: 0 10px 25px rgba(14, 165, 233, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 40px rgba(14, 165, 233, 0.4);
        }

        .btn-green {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
        }

        .btn-green:hover {
            box-shadow: 0 20px 40px rgba(16, 185, 129, 0.4);
        }

        .btn-purple {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            box-shadow: 0 10px 25px rgba(139, 92, 246, 0.3);
        }

        .btn-purple:hover {
            box-shadow: 0 20px 40px rgba(139, 92, 246, 0.4);
        }

        .btn-orange {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3);
        }

        .btn-orange:hover {
            box-shadow: 0 20px 40px rgba(245, 158, 11, 0.4);
        }

        .total-counter {
            text-align: center;
            font-size: 1.75rem;
            font-weight: 800;
            color: white;
            background: linear-gradient(135deg, rgba(255,255,255,0.25), rgba(255,255,255,0.15));
            padding: 1.5rem;
            border-radius: 1.5rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.3);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            color: white;
            margin: 2rem 0;
            font-weight: 600;
            font-size: 1.125rem;
        }

        .spinner {
            width: 2.5rem;
            height: 2.5rem;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .table-container {
            overflow-x: auto;
            border: 1px solid #e2e8f0;
            border-radius: 1rem;
            margin-top: 1rem;
            background: white;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        th {
            background: linear-gradient(135deg, #0ea5e9, #3b82f6);
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        td {
            padding: 1rem;
            text-align: center;
            border: 1px solid #e2e8f0;
            background: white;
            font-weight: 500;
        }

        tr:nth-child(even) td {
            background: #f8fafc;
        }

        tr:hover td {
            background: #e0f2fe;
        }

        .table-header-main {
            background: linear-gradient(135deg, #f59e0b, #d97706) !important;
            color: white !important;
            font-weight: 800;
            font-size: 1rem;
        }

        .table-subheader {
            background: linear-gradient(135deg, #64748b, #475569) !important;
            color: white !important;
            font-weight: 600;
            font-size: 0.75rem;
        }

        .area-cell {
            background: linear-gradient(135deg, #ecfdf5, #d1fae5) !important;
            font-weight: 700;
            text-align: left !important;
            padding-left: 1.5rem !important;
            color: #065f46;
        }

        .total-row td {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe) !important;
            font-weight: 800;
            color: #1e40af;
        }

        .mapping-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .mapping-group {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border: 2px solid #e2e8f0;
            border-radius: 1rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .mapping-group:hover {
            border-color: #0ea5e9;
            transform: translateY(-2px);
        }

        .mapping-label {
            font-size: 0.875rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .mapping-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 0.75rem;
            font-size: 0.875rem;
            background: white;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .mapping-select:focus {
            outline: none;
            border-color: #0ea5e9;
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1);
        }

        .file-header {
            background: linear-gradient(135deg, #0ea5e9, #3b82f6);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 1rem 1rem 0 0;
            font-weight: 700;
            margin-bottom: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .hidden {
            display: none !important;
        }

        .icon {
            width: 1.25rem;
            height: 1.25rem;
            fill: currentColor;
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 320px;
                justify-content: center;
            }
            
            .mapping-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 Data Summary Analytics</h1>
            <p>Upload CSV files and generate professional summaries with advanced export options</p>
        </div>

        <div id="upload-section" class="card">
            <div class="upload-area">
                <div class="upload-dropzone" id="dropzone">
                    <input type="file" id="file-input" class="file-input" multiple accept=".csv">
                    <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7,10 12,15 17,10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    <h3 style="font-size: 1.5rem; margin-bottom: 0.5rem; font-weight: 700;">Drop CSV files here</h3>
                    <p style="color: #64748b; font-weight: 500;">or click to browse and select files</p>
                </div>
            </div>
        </div>

        <div id="mapping-section" class="card hidden">
            <div class="summary-header">
                <h3 class="summary-title">🔧 Column Mapping Configuration</h3>
                <div>
                    <button id="use-auto-mapping" class="btn btn-orange" style="margin-right: 1rem;">Auto-Map</button>
                    <button id="apply-mapping" class="btn btn-green">Apply & Continue</button>
                </div>
            </div>
            <div id="mapping-container"></div>
        </div>

        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <span>Processing your files...</span>
        </div>

        <div id="summary-section" class="hidden">
            <div class="total-counter">
                <span id="total-records">📈 Total Records: 0</span>
            </div>

            <div class="controls">
                <button id="export-all-csv" class="btn btn-green">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7,10 12,15 17,10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Export All Data
                </button>
                <button id="export-summary" class="btn btn-purple">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <polyline points="21,15 16,10 5,21"/>
                    </svg>
                    Export Summary
                </button>
            </div>

            <div id="summary-export-area">
                <div class="card" id="area-cluster-summary">
                    <div class="summary-header">
                        <h3 class="summary-title">📍 Area Cluster Summary</h3>
                        <button class="btn btn-green" onclick="exportAreaClusterSummary()">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7,10 12,15 17,10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            Export Table
                        </button>
                    </div>
                    <div class="table-container" id="area-cluster-table"></div>
                </div>
                
                <div class="summary-grid" id="summary-cards"></div>
            </div>
        </div>
    </div>

    <script>
        let parsedData = [];
        let consolidatedData = [];
        let summaryStats = null;
        let manualColumnMappings = {};

        const standardColumns = {
            bank: ['BANK NAME', 'BANK', 'bank_txt', 'BANK NAME REAL'],
            area: ['AREA', 'FINAL AREA', 'final_area_txt', 'AREA CLUSTER'],
            cluster: ['CLUSTER', 'CH CODE', 'CH NAME'],
            status: ['account_status', 'STATUS', 'reported_status', 'OPEN CI STATUS', 'RESULT', 'VISIT STATUS'],
            fieldRider: ['ASSIGNED FS', 'FIELDMAN', 'Creator', 'FIELD RIDER', 'FS NAME'],
            chCode: ['CH CODE', 'REF CODE', 'REFERENCE'],
            date: ['Creation Date', 'Result_Date', 'result_date', 'VISITED DATE', 'Modified Date', 'DATE']
        };

        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
        });

        function initializeEventListeners() {
            const fileInput = document.getElementById('file-input');
            const dropzone = document.getElementById('dropzone');

            dropzone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileUpload);

            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('dragover');
            });

            dropzone.addEventListener('dragleave', () => {
                dropzone.classList.remove('dragover');
            });

            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('dragover');
                const droppedFiles = Array.from(e.dataTransfer.files);
                processFiles(droppedFiles);
            });

            document.getElementById('export-all-csv').addEventListener('click', exportAllData);
            document.getElementById('export-summary').addEventListener('click', exportSummaryImage);
            document.getElementById('use-auto-mapping').addEventListener('click', useAutoMapping);
            document.getElementById('apply-mapping').addEventListener('click', applyManualMapping);
        }

        async function handleFileUpload(event) {
            const uploadedFiles = Array.from(event.target.files);
            await processFiles(uploadedFiles);
        }

        async function processFiles(files) {
            if (files.length === 0) return;

            const loadingElement = document.getElementById('loading');
            loadingElement.classList.remove('hidden');
            
            try {
                parsedData = [];
                consolidatedData = [];
                summaryStats = null;
                manualColumnMappings = {};
                
                for (const file of files) {
                    try {
                        const text = await file.text();
                        const parsed = Papa.parse(text, {
                            header: true,
                            dynamicTyping: true,
                            skipEmptyLines: true,
                            delimitersToGuess: [',', '\t', '|', ';']
                        });
                        
                        if (parsed.errors && parsed.errors.length > 0) {
                            console.warn(`Parsing warnings for ${file.name}:`, parsed.errors);
                        }
                        
                        const cleanedData = parsed.data
                            .filter(row => {
                                return Object.values(row).some(value => 
                                    value !== null && 
                                    value !== undefined && 
                                    value !== '' && 
                                    String(value).trim() !== ''
                                );
                            })
                            .map(row => {
                                const cleanRow = {};
                                Object.keys(row).forEach(key => {
                                    const cleanKey = key.trim();
                                    cleanRow[cleanKey] = row[key];
                                });
                                return cleanRow;
                            });
                        
                        if (cleanedData.length > 0) {
                            parsedData.push({
                                name: file.name,
                                data: cleanedData,
                                headers: Object.keys(cleanedData[0] || {}),
                                rowCount: cleanedData.length
                            });
                        }
                        
                    } catch (fileError) {
                        console.error(`Error processing file ${file.name}:`, fileError);
                        alert(`Error processing file ${file.name}. Please check if it's a valid CSV file.`);
                    }
                }
                
                if (parsedData.length === 0) {
                    alert('No valid data found in the uploaded files.');
                    return;
                }
                
                showColumnMapping();
                console.log('File processing completed successfully!');
                
            } catch (error) {
                console.error('Error processing files:', error);
                alert('Error processing files. Please try again with valid CSV files.');
            } finally {
                loadingElement.classList.add('hidden');
                const fileInput = document.getElementById('file-input');
                fileInput.value = '';
            }
        }

        function showColumnMapping() {
            const mappingSection = document.getElementById('mapping-section');
            const mappingContainer = document.getElementById('mapping-container');
            
            mappingContainer.innerHTML = '';
            manualColumnMappings = {};
            
            parsedData.forEach((file, fileIndex) => {
                const autoMapping = {};
                Object.keys(standardColumns).forEach(stdCol => {
                    const matchedCol = file.headers.find(header => 
                        standardColumns[stdCol].some(variant => 
                            header.toUpperCase().includes(variant.toUpperCase())
                        )
                    );
                    if (matchedCol) {
                        autoMapping[stdCol] = matchedCol;
                    }
                });
                
                manualColumnMappings[fileIndex] = autoMapping;
                
                const fileMapping = document.createElement('div');
                fileMapping.className = 'mapping-group';
                
                fileMapping.innerHTML = `
                    <div class="file-header">
                        📄 ${file.name} (${file.rowCount} rows)
                    </div>
                    <div class="mapping-grid">
                        ${Object.keys(standardColumns).map(columnType => `
                            <div>
                                <label class="mapping-label">
                                    ${columnType.replace(/([A-Z])/g, ' $1').trim()}
                                </label>
                                <select class="mapping-select" data-file-index="${fileIndex}" data-column-type="${columnType}">
                                    <option value="">-- Select Column --</option>
                                    ${file.headers.map(header => `
                                        <option value="${header}" ${autoMapping[columnType] === header ? 'selected' : ''}>
                                            ${header}
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                mappingContainer.appendChild(fileMapping);
            });
            
            document.querySelectorAll('.mapping-select').forEach(select => {
                select.addEventListener('change', (e) => {
                    const fileIndex = parseInt(e.target.getAttribute('data-file-index'));
                    const columnType = e.target.getAttribute('data-column-type');
                    const selectedColumn = e.target.value;
                    
                    if (!manualColumnMappings[fileIndex]) {
                        manualColumnMappings[fileIndex] = {};
                    }
                    manualColumnMappings[fileIndex][columnType] = selectedColumn;
                });
            });
            
            mappingSection.classList.remove('hidden');
        }

        function useAutoMapping() {
            manualColumnMappings = {};
            parsedData.forEach((file, fileIndex) => {
                const autoMapping = {};
                Object.keys(standardColumns).forEach(stdCol => {
                    const matchedCol = file.headers.find(header => 
                        standardColumns[stdCol].some(variant => 
                            header.toUpperCase().includes(variant.toUpperCase())
                        )
                    );
                    if (matchedCol) {
                        autoMapping[stdCol] = matchedCol;
                    }
                });
                manualColumnMappings[fileIndex] = autoMapping;
            });
            
            document.querySelectorAll('.mapping-select').forEach(select => {
                const fileIndex = parseInt(select.getAttribute('data-file-index'));
                const columnType = select.getAttribute('data-column-type');
                const autoValue = manualColumnMappings[fileIndex]?.[columnType] || '';
                select.value = autoValue;
            });
            
            alert('Auto-mapping applied! Review the selections and click "Apply & Continue" to proceed.');
        }

        function applyManualMapping() {
            const hasMappings = Object.values(manualColumnMappings).some(mapping => 
                Object.values(mapping).some(value => value !== '')
            );
            
            if (!hasMappings) {
                alert('Please map at least some columns before proceeding.');
                return;
            }
            
            consolidateData();
            generateSummary();
            showSummary();
            
            document.getElementById('mapping-section').classList.add('hidden');
        }

        function consolidateData() {
            try {
                consolidatedData = [];
                
                if (!parsedData || parsedData.length === 0) {
                    console.log('No parsed data available for consolidation');
                    return;
                }
                
                parsedData.forEach((file, fileIndex) => {
                    console.log(`Processing file: ${file.name} with ${file.data.length} rows`);
                    
                    const columnMap = manualColumnMappings[fileIndex] || {};
                    
                    if (Object.keys(columnMap).length === 0) {
                        Object.keys(standardColumns).forEach(stdCol => {
                            const matchedCol = file.headers.find(header => 
                                standardColumns[stdCol].some(variant => 
                                    header.toUpperCase().includes(variant.toUpperCase())
                                )
                            );
                            if (matchedCol) {
                                columnMap[stdCol] = matchedCol;
                            }
                        });
                    }
                    
                    console.log(`Column mapping for ${file.name}:`, columnMap);
                    
                    file.data.forEach((row, rowIndex) => {
                        const hasData = Object.values(row).some(value => 
                            value !== null && 
                            value !== undefined && 
                            value !== '' && 
                            String(value).trim() !== ''
                        );
                        
                        if (hasData) {
                            const consolidatedRow = {
                                fileName: file.name,
                                bank: row[columnMap.bank] || 'Unknown',
                                area: row[columnMap.area] || 'Unknown',
                                cluster: row[columnMap.cluster] || 'Unknown',
                                status: row[columnMap.status] || 'Unknown',
                                fieldRider: row[columnMap.fieldRider] || 'Unknown',
                                chCode: row[columnMap.chCode] || 'Unknown',
                                date: row[columnMap.date] || 'Unknown',
                                originalRow: row
                            };
                            consolidatedData.push(consolidatedRow);
                        }
                    });
                });
                
                console.log(`Consolidated ${consolidatedData.length} total records from ${parsedData.length} files`);
                
            } catch (error) {
                console.error('Error in consolidateData:', error);
                alert('Error consolidating data. Please check your CSV file format.');
            }
        }

        function generateSummary() {
            try {
                if (!consolidatedData || consolidatedData.length === 0) {
                    console.log('No consolidated data available for summary generation');
                    summaryStats = null;
                    return;
                }

                const stats = {
                    total: consolidatedData.length,
                    byBank: {},
                    byArea: {},
                    byStatus: {},
                    byFieldRider: {},
                    byCluster: {}
                };

                consolidatedData.forEach(row => {
                    stats.byBank[row.bank] = (stats.byBank[row.bank] || 0) + 1;
                    stats.byArea[row.area] = (stats.byArea[row.area] || 0) + 1;
                    stats.byStatus[row.status] = (stats.byStatus[row.status] || 0) + 1;
                    stats.byFieldRider[row.fieldRider] = (stats.byFieldRider[row.fieldRider] || 0) + 1;
                    stats.byCluster[row.cluster] = (stats.byCluster[row.cluster] || 0) + 1;
                });

                summaryStats = {
                    total: stats.total,
                    byBank: Object.entries(stats.byBank).sort((a, b) => b[1] - a[1]),
                    byArea: Object.entries(stats.byArea).sort((a, b) => b[1] - a[1]),
                    byStatus: Object.entries(stats.byStatus).sort((a, b) => b[1] - a[1]),
                    byFieldRider: Object.entries(stats.byFieldRider).sort((a, b) => b[1] - a[1]),
                    byCluster: Object.entries(stats.byCluster).sort((a, b) => b[1] - a[1])
                };
                
                console.log('Summary stats generated:', summaryStats);
                
            } catch (error) {
                console.error('Error in generateSummary:', error);
                summaryStats = null;
                alert('Error generating summary statistics.');
            }
        }

        function showSummary() {
            if (!summaryStats) return;

            document.getElementById('total-records').textContent = `📈 Total Records: ${summaryStats.total.toLocaleString()}`;

            createAreaClusterTable();

            const summaryCards = document.getElementById('summary-cards');
            summaryCards.innerHTML = '';

            const cardConfigs = [
                { title: '🏦 By Bank', data: summaryStats.byBank, color: '#10b981' },
                { title: '📍 By Area', data: summaryStats.byArea, color: '#0ea5e9' },
                { title: '📊 By Status', data: summaryStats.byStatus, color: '#ef4444' },
                { title: '👤 By Field Rider', data: summaryStats.byFieldRider, color: '#f59e0b' },
                { title: '🏢 By Cluster', data: summaryStats.byCluster, color: '#8b5cf6' }
            ];

            cardConfigs.forEach(config => {
                const card = createSummaryCard(config);
                summaryCards.appendChild(card);
            });

            document.getElementById('summary-section').classList.remove('hidden');
        }

        function createAreaClusterTable() {
            if (!consolidatedData.length) return;

            const areaData = {};
            let totalVisits = 0;

            consolidatedData.forEach(row => {
                const area = row.area;
                if (!areaData[area]) {
                    areaData[area] = {
                        visits: 0,
                        fieldRiders: new Set()
                    };
                }
                
                areaData[area].visits += 1;
                areaData[area].fieldRiders.add(row.fieldRider);
                totalVisits += 1;
            });

            const totalFieldRiders = new Set();
            consolidatedData.forEach(row => totalFieldRiders.add(row.fieldRider));
            const totalSkipTracers = totalFieldRiders.size;

            const tableContainer = document.getElementById('area-cluster-table');
            const currentDate = new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th colspan="7" class="table-header-main">
                                ${currentDate.toUpperCase()} RESULT AS OF ${new Date().toLocaleTimeString('en-US', { hour12: true })} (Less Cancel)
                            </th>
                        </tr>
                        <tr>
                            <th rowspan="2" class="table-subheader">AREA CLUSTER</th>
                            <th colspan="2" class="table-subheader">VISITED</th>
                            <th colspan="4" class="table-subheader" style="background: linear-gradient(135deg, #dcfce7, #bbf7d0) !important; color: #065f46 !important;">@1K/FS</th>
                        </tr>
                        <tr>
                            <th class="table-subheader">CI</th>
                            <th class="table-subheader">SHARED</th>
                            <th class="table-subheader" style="background: linear-gradient(135deg, #dcfce7, #bbf7d0) !important; color: #065f46 !important;">TOTAL</th>
                            <th class="table-subheader" style="background: linear-gradient(135deg, #dcfce7, #bbf7d0) !important; color: #065f46 !important;">SKIPTRACERS</th>
                            <th class="table-subheader" style="background: linear-gradient(135deg, #dcfce7, #bbf7d0) !important; color: #065f46 !important;">PROB. COST</th>
                            <th class="table-subheader" style="background: linear-gradient(135deg, #dcfce7, #bbf7d0) !important; color: #065f46 !important;">COS/VISIT</th>
                            <th class="table-subheader" style="background: linear-gradient(135deg, #dcfce7, #bbf7d0) !important; color: #065f46 !important;">AVE. VISIT</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            Object.entries(areaData).forEach(([area, data]) => {
                const riderCount = data.fieldRiders.size;
                const dailySalaryCost = riderCount * 1000;
                const costPerVisit = data.visits > 0 ? (dailySalaryCost / data.visits) : 0;
                const avgVisit = riderCount > 0 ? (data.visits / riderCount) : 0;

                const ciVisits = Math.floor(data.visits * 0.6);
                const sharedVisits = data.visits - ciVisits;

                tableHTML += `
                    <tr>
                        <td class="area-cell">${area}</td>
                        <td>${ciVisits}</td>
                        <td>${sharedVisits}</td>
                        <td style="background: linear-gradient(135deg, #dcfce7, #bbf7d0) !important; color: #065f46; font-weight: 600;">${data.visits}</td>
                        <td style="background: linear-gradient(135deg, #dcfce7, #bbf7d0) !important; color: #065f46; font-weight: 600;">${riderCount}</td>
                        <td style="background: linear-gradient(135deg, #dcfce7, #bbf7d0) !important; color: #065f46; font-weight: 600;">${dailySalaryCost.toLocaleString()}</td>
                        <td style="background: linear-gradient(135deg, #dcfce7, #bbf7d0) !important; color: #065f46; font-weight: 600;">${costPerVisit.toFixed(2)}</td>
                        <td style="background: linear-gradient(135deg, #dcfce7, #bbf7d0) !important; color: #065f46; font-weight: 600;">${avgVisit.toFixed(2)}</td>
                    </tr>
                `;
            });

            const totalRiderCount = totalFieldRiders.size;
            const totalDailySalaryCost = totalRiderCount * 1000;
            const totalCostPerVisit = totalVisits > 0 ? (totalDailySalaryCost / totalVisits) : 0;
            const totalAvgVisit = totalRiderCount > 0 ? (totalVisits / totalRiderCount) : 0;
            
            const totalCiVisits = Math.floor(totalVisits * 0.6);
            const totalSharedVisits = totalVisits - totalCiVisits;

            tableHTML += `
                    <tr class="total-row">
                        <td><strong>TOTAL</strong></td>
                        <td><strong>${totalCiVisits}</strong></td>
                        <td><strong>${totalSharedVisits}</strong></td>
                        <td style="background: linear-gradient(135deg, #dbeafe, #bfdbfe) !important;"><strong>${totalVisits}</strong></td>
                        <td style="background: linear-gradient(135deg, #dbeafe, #bfdbfe) !important;"><strong>${totalSkipTracers}</strong></td>
                        <td style="background: linear-gradient(135deg, #dbeafe, #bfdbfe) !important;"><strong>${totalDailySalaryCost.toLocaleString()}</strong></td>
                        <td style="background: linear-gradient(135deg, #dbeafe, #bfdbfe) !important;"><strong>${totalCostPerVisit.toFixed(2)}</strong></td>
                        <td style="background: linear-gradient(135deg, #dbeafe, #bfdbfe) !important;"><strong>${totalAvgVisit.toFixed(2)}</strong></td>
                    </tr>
                </tbody>
            </table>
            `;

            tableContainer.innerHTML = tableHTML;
        }

        function createSummaryCard({ title, data, color }) {
            const total = data.reduce((sum, [, value]) => sum + value, 0);
            
            const card = document.createElement('div');
            card.className = 'summary-card';
            card.style.borderLeftColor = color;
            
            const listItems = data.slice(0, 8).map(([key, value]) => `
                <div class="summary-item">
                    <span class="summary-label">${key}</span>
                    <div class="summary-value">
                        <span class="summary-count">${value.toLocaleString()}</span>
                        <span class="summary-percent">${((value / total) * 100).toFixed(1)}%</span>
                    </div>
                </div>
            `).join('');

            card.innerHTML = `
                <div class="summary-header">
                    <h3 class="summary-title">${title}</h3>
                    <button class="btn" onclick="exportCardData('${title}', ${JSON.stringify(data).replace(/"/g, '&quot;')})">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7,10 12,15 17,10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                    </button>
                </div>
                
                <div class="summary-total" style="color: ${color};">
                    ${total.toLocaleString()}
                </div>
                
                <div class="summary-list">
                    ${listItems}
                    ${data.length > 8 ? `
                        <div style="text-align: center; padding: 0.75rem; color: #64748b; font-size: 0.875rem; font-weight: 500;">
                            ... and ${data.length - 8} more items
                        </div>
                    ` : ''}
                </div>
            `;
            
            return card;
        }

        function exportCardData(title, data) {
            const csvData = data.map(([key, value]) => ({
                [title.replace(/[^\w\s]/gi, '')]: key,
                Count: value,
                Percentage: ((value / data.reduce((sum, [, val]) => sum + val, 0)) * 100).toFixed(2) + '%'
            }));
            
            exportToCSV(csvData, `${title.replace(/[^\w\s]/gi, '').replace(/\s+/g, '_')}_Summary.csv`);
        }

        function exportAreaClusterSummary() {
            if (!consolidatedData.length) {
                alert('No data to export');
                return;
            }

            const areaData = {};
            consolidatedData.forEach(row => {
                const area = row.area;
                if (!areaData[area]) {
                    areaData[area] = {
                        visits: 0,
                        fieldRiders: new Set()
                    };
                }
                
                areaData[area].visits += 1;
                areaData[area].fieldRiders.add(row.fieldRider);
            });

            const csvData = Object.entries(areaData).map(([area, data]) => {
                const riderCount = data.fieldRiders.size;
                const dailySalaryCost = riderCount * 1000;
                const costPerVisit = data.visits > 0 ? (dailySalaryCost / data.visits) : 0;
                const avgVisit = riderCount > 0 ? (data.visits / riderCount) : 0;
                const ciVisits = Math.floor(data.visits * 0.6);
                const sharedVisits = data.visits - ciVisits;

                return {
                    'Area Cluster': area,
                    'CI Visits': ciVisits,
                    'Shared Visits': sharedVisits,
                    'Total Visits': data.visits,
                    'Skip Tracers (Field Riders)': riderCount,
                    'Daily Salary Cost (1K/FS)': dailySalaryCost,
                    'Cost Per Visit': costPerVisit.toFixed(2),
                    'Average Visit per Rider': avgVisit.toFixed(2)
                };
            });

            exportToCSV(csvData, 'Area_Cluster_Summary.csv');
        }

        function exportAllData() {
            if (!consolidatedData.length) {
                alert('No data to export');
                return;
            }

            const exportData = consolidatedData.map(row => ({
                'File Name': row.fileName,
                'Bank': row.bank,
                'Area': row.area,
                'Cluster': row.cluster,
                'Status': row.status,
                'Field Rider': row.fieldRider,
                'CH Code': row.chCode,
                'Date': row.date
            }));
            
            exportToCSV(exportData, 'Complete_Data_Export.csv');
        }

        function exportToCSV(data, filename) {
            try {
                const csv = Papa.unparse(data);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.href = url;
                link.download = filename;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }, 100);
                
            } catch (error) {
                console.error('Error exporting CSV:', error);
                alert('Error exporting CSV file. Please try again.');
            }
        }

        function exportSummaryImage() {
            const summaryArea = document.getElementById('summary-export-area');
            if (!summaryArea) {
                alert('No summary to export');
                return;
            }

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = 1400;
            canvas.height = 900;
            
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, '#0ea5e9');
            gradient.addColorStop(0.5, '#3b82f6');
            gradient.addColorStop(1, '#8b5cf6');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 40px Inter';
            ctx.textAlign = 'center';
            ctx.fillText('📊 Data Summary Analytics Report', canvas.width / 2, 60);
            
            ctx.font = '18px Inter';
            ctx.fillStyle = '#f1f5f9';
            ctx.fillText(`Generated: ${new Date().toLocaleString()}`, canvas.width / 2, 90);
            
            ctx.font = 'bold 28px Inter';
            ctx.fillStyle = '#ffffff';
            ctx.fillText(`Total Records: ${summaryStats?.total.toLocaleString() || 0}`, canvas.width / 2, 140);
            
            if (summaryStats) {
                let yPos = 190;
                ctx.font = '20px Inter';
                ctx.textAlign = 'left';
                ctx.fillStyle = '#ffffff';
                
                const summaries = [
                    `🏦 Banks: ${summaryStats.byBank.length} different banks`,
                    `📍 Areas: ${summaryStats.byArea.length} different areas`,
                    `📊 Status Types: ${summaryStats.byStatus.length} different statuses`,
                    `👤 Field Riders: ${summaryStats.byFieldRider.length} different field riders`,
                    `🏢 Clusters: ${summaryStats.byCluster.length} different clusters`
                ];
                
                summaries.forEach(text => {
                    ctx.fillText(text, 80, yPos);
                    yPos += 35;
                });
                
                yPos += 30;
                ctx.font = 'bold 24px Inter';
                ctx.fillText('🔥 Top Items by Category:', 80, yPos);
                yPos += 40;
                
                ctx.font = '18px Inter';
                const categories = [
                    { name: '🏦 Top Banks', data: summaryStats.byBank.slice(0, 3) },
                    { name: '📍 Top Areas', data: summaryStats.byArea.slice(0, 3) },
                    { name: '📊 Top Statuses', data: summaryStats.byStatus.slice(0, 3) }
                ];
                
                categories.forEach(category => {
                    ctx.font = 'bold 20px Inter';
                    ctx.fillText(`${category.name}:`, 80, yPos);
                    yPos += 30;
                    
                    ctx.font = '16px Inter';
                    category.data.forEach(([name, count]) => {
                        ctx.fillText(`  • ${name}: ${count.toLocaleString()}`, 100, yPos);
                        yPos += 25;
                    });
                    yPos += 15;
                });
            }
            
            canvas.toBlob((blob) => {
                if (blob) {
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.href = url;
                    link.download = 'Data_Summary_Analytics_Report.png';
                    link.style.display = 'none';
                    
                    document.body.appendChild(link);
                    link.click();
                    
                    setTimeout(() => {
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                    }, 100);
                }
            }, 'image/png');
        }
    </script>
</body>
</html>